<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RIDER LIVE: ГЕОМЕТРИЯ</title>
    
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.14.0/dist/ort.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Roboto:wght@300;400&display=swap" rel="stylesheet">
    
    <style>
        /* ОСНОВА */
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Roboto', sans-serif; color: #e0c097; }
        #container { position: relative; width: 100vw; height: 100vh; }
        
        video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }

        /* ИНТЕРФЕЙС */
        .ui-layer { position: absolute; top:0; left:0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; z-index: 20; }
        
        .top-panel { 
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent); 
            padding: 20px; text-align: center; pointer-events: auto;
        }
        .app-title { font-family: 'Cinzel', serif; font-size: 22px; color: #e0c097; text-shadow: 0 2px 5px #000; }
        .status-badge { 
            display: inline-block; background: rgba(0,0,0,0.5); padding: 5px 15px; 
            border-radius: 20px; border: 1px solid #e0c097; font-size: 14px; margin-top: 10px; color: #fff;
        }

        .bottom-panel { 
            padding: 40px; text-align: center; 
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); 
            pointer-events: auto; display: flex; justify-content: center; gap: 20px;
        }

        /* КНОПКА СЪЕМКИ */
        .shutter-btn { 
            width: 80px; height: 80px; border-radius: 50%; border: 4px solid #e0c097; 
            background: rgba(224, 192, 151, 0.2); position: relative; cursor: pointer; 
            transition: 0.2s; box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        .shutter-btn::after {
            content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 60px; height: 60px; background: #e0c097; border-radius: 50%;
        }
        .shutter-btn:active { transform: scale(0.9); }

        /* КНОПКА ПОВТОРА */
        .retry-btn {
            display: none; padding: 15px 40px; background: #222; border: 2px solid #e0c097; 
            color: #e0c097; font-family: 'Cinzel'; font-weight: bold; font-size: 16px; 
            border-radius: 40px; cursor: pointer; box-shadow: 0 0 15px rgba(224, 192, 151, 0.3);
        }

        /* ОКНО РЕЗУЛЬТАТА (ВИЗУАЛЬНАЯ СХЕМА) */
        #result-popup { 
            position: absolute; bottom: 0; left: 0; width: 100%; height: 65%; 
            background: #111; border-top: 3px solid #e0c097; z-index: 100; 
            display: none; flex-direction: column; border-radius: 20px 20px 0 0;
            box-shadow: 0 -10px 50px rgba(0,0,0,1);
        }
        .res-header { 
            padding: 15px; text-align: center; font-family: 'Cinzel'; color: #e0c097; 
            font-size: 18px; border-bottom: 1px solid #333; 
        }
        /* Контейнер для визуального расклада */
        #layout-view { 
            flex: 1; position: relative; background: #0e0e0e; overflow: hidden; margin: 10px; 
            border: 1px dashed #333; border-radius: 10px;
        }
        /* Сами карты в результате */
        .detected-card {
            position: absolute; border-radius: 5px; 
            border: 2px solid #e0c097; box-shadow: 0 4px 10px rgba(0,0,0,0.8);
            transition: transform 0.3s;
        }
        .detected-card img { width: 100%; height: 100%; object-fit: cover; border-radius: 4px; }
        .detected-card span {
            position: absolute; bottom: -20px; width: 120%; left: -10%; text-align: center;
            font-size: 10px; color: #fff; text-shadow: 0 0 3px #000; white-space: nowrap;
        }

        /* ЗАГРУЗКА */
        #start-screen { position: absolute; top:0; left:0; width:100%; height:100%; background:#000; z-index:999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .loader { width: 40px; height: 40px; border: 4px solid #333; border-top: 4px solid #e0c097; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="container">
        <div id="start-screen">
            <h1 style="font-family: 'Cinzel'; color: #e0c097; margin-bottom: 10px;">RIDER LIVE</h1>
            <div class="loader"></div>
            <div id="loading-txt" style="color: #666;">Загрузка нейросети (640px)...</div>
            <button id="start-btn" onclick="initSystem()" style="margin-top:20px; padding:10px 30px; display:none; border:1px solid #e0c097; background:transparent; color:#e0c097; cursor:pointer;">ЗАПУСК</button>
        </div>

        <video id="input-video" playsinline muted autoplay></video>
        <canvas id="canvas"></canvas>
        
        <div class="ui-layer">
            <div class="top-panel">
                <div class="app-title">СКАНЕР ТАРО</div>
                <div id="status-badge" class="status-badge">Наведите на карты</div>
            </div>
            
            <div class="bottom-panel">
                <div id="shutter" class="shutter-btn" onclick="captureSnapshot()"></div>
                <button id="retry" class="retry-btn" onclick="resetSystem()">↺ ПОВТОРИТЬ</button>
            </div>
        </div>

        <div id="result-popup">
            <div class="res-header">ВАШ РАСКЛАД (ГЕОМЕТРИЯ)</div>
            <div id="layout-view">
                <div style="position: absolute; top:50%; left:50%; transform:translate(-50%,-50%); color:#444;">Здесь появятся карты</div>
            </div>
        </div>
    </div>

    <script>
        // === 1. БАЗА КАРТ (GitHub Ссылки) ===
        const BASE_IMG = "https://raw.githubusercontent.com/marataitester-blip/rider-tarot-card/main/Cards-jpg/Cards-jpg/";
        const TAROT_DATA = [];

        // Старшие Арканы
        const majorsConfig = [
            {n:"Шут", f:"00-TheFool.jpg"}, {n:"Маг", f:"01-TheMagician.jpg"}, {n:"Жрица", f:"02-TheHighPriestess.jpg"},
            {n:"Императрица", f:"03-TheEmpress.jpg"}, {n:"Император", f:"04-TheEmperor.jpg"}, {n:"Жрец", f:"05-TheHierophant.jpg"},
            {n:"Влюбленные", f:"06-TheLovers.jpg"}, {n:"Колесница", f:"07-TheChariot.jpg"}, {n:"Сила", f:"08-Strength.jpg"},
            {n:"Отшельник", f:"09-TheHermit.jpg"}, {n:"Колесо Фортуны", f:"10-WheelOfFortune.jpg"}, {n:"Справедливость", f:"11-Justice.jpg"},
            {n:"Повешенный", f:"12-TheHangedMan.jpg"}, {n:"Смерть", f:"13-Death.jpg"}, {n:"Умеренность", f:"14-Temperance.jpg"},
            {n:"Дьявол", f:"15-TheDevil.jpg"}, {n:"Башня", f:"16-TheTower.jpg"}, {n:"Звезда", f:"17-TheStar.jpg"},
            {n:"Луна", f:"18-TheMoon.jpg"}, {n:"Солнце", f:"19-TheSun.jpg"}, {n:"Суд", f:"20-Judgement.jpg"},
            {n:"Мир", f:"21-TheWorld.jpg"}
        ];
        majorsConfig.forEach(m => TAROT_DATA.push({name: m.n, img: BASE_IMG + m.f}));

        // Младшие Арканы
        const suits = [
            {id: 'Wands', ru: 'Жезлов'}, {id: 'Cups', ru: 'Кубков'}, 
            {id: 'Swords', ru: 'Мечей'}, {id: 'Pentacles', ru: 'Пентаклей'}
        ];
        const ranks = ['Ace', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine', 'Ten', 'Page', 'Knight', 'Queen', 'King'];
        const rankNamesRu = ['Туз', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'Паж', 'Рыцарь', 'Королева', 'Король'];

        suits.forEach(s => {
            ranks.forEach((r, idx) => {
                const numStr = (idx + 1).toString().padStart(2, '0');
                const fileName = `${s.id}${numStr}.jpg`;
                TAROT_DATA.push({ name: `${rankNamesRu[idx]} ${s.ru}`, img: BASE_IMG + fileName });
            });
        });

        // === 2. НАСТРОЙКИ ===
        const MODEL_PATH = './rider_5k_640.onnx'; 
        const MODEL_SIZE = 640; 
        const CONFIDENCE = 0.40; 
        const NMS_THRESHOLD = 0.50;

        let session;
        let isPaused = false; // Флаг заморозки
        let lastDetections = []; // Последние найденные карты

        const video = document.getElementById('input-video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const statusBadge = document.getElementById('status-badge');

        ort.env.wasm.numThreads = 2; ort.env.wasm.simd = false;

        // === 3. ЗАПУСК ===
        async function initSystem() {
            document.getElementById('start-btn').style.display = 'none';
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment', width: {ideal: 1280}, height: {ideal: 720} }, 
                    audio: false 
                });
                video.srcObject = stream;
                video.style.display = 'block'; 
                await new Promise(r => video.onloadedmetadata = r);

                session = await ort.InferenceSession.create(MODEL_PATH, { executionProviders: ['wasm'] });
                
                document.getElementById('start-screen').style.display = 'none';
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;

                detectLoop(); // Запуск живого цикла
            } catch (e) {
                alert("Ошибка: " + e.message);
                document.getElementById('start-btn').style.display = 'inline-block';
            }
        }
        window.onload = () => document.getElementById('start-btn').style.display = 'inline-block';

        // === 4. ЦИКЛ ДЕТЕКЦИИ (LIVE) ===
        async function detectLoop() {
            if (isPaused) return; // Если нажали кнопку - стоп

            const mat = document.createElement('canvas');
            mat.width = MODEL_SIZE; mat.height = MODEL_SIZE;
            mat.getContext('2d').drawImage(video, 0, 0, MODEL_SIZE, MODEL_SIZE);
            const data = mat.getContext('2d').getImageData(0,0,MODEL_SIZE,MODEL_SIZE).data;
            const input = new Float32Array(3 * MODEL_SIZE * MODEL_SIZE);
            for (let i=0; i<MODEL_SIZE*MODEL_SIZE; i++) {
                input[i] = data[i*4]/255.0; input[MODEL_SIZE*MODEL_SIZE+i] = data[i*4+1]/255.0; input[2*MODEL_SIZE*MODEL_SIZE+i] = data[i*4+2]/255.0;
            }
            const tensor = new ort.Tensor('float32', input, [1, 3, MODEL_SIZE, MODEL_SIZE]);

            try {
                const results = await session.run({ [session.inputNames[0]]: tensor });
                drawLiveBoxes(results[session.outputNames[0]].data);
            } catch (e) { console.error(e); }

            requestAnimationFrame(detectLoop);
        }

        // === 5. ОТРИСОВКА РАМОК В ЖИВУЮ ===
        function drawLiveBoxes(data) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const numClasses = 78; const channels = numClasses + 4; const dynamicAnchors = data.length / channels;
            let boxes = [];
            for (let i=0; i<dynamicAnchors; i++) {
                let maxConf = 0; let classIdx = 0;
                for(let c=4; c<channels; c++) { const val = data[c*dynamicAnchors+i]; if(val > maxConf) { maxConf = val; classIdx = c-4; } }
                if (maxConf > CONFIDENCE) {
