<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RIDER WAITE: PRO SCANNER</title>
    
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.14.0/dist/ort.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Roboto:wght@300;400&display=swap" rel="stylesheet">
    
    <style>
        /* –û–°–ù–û–í–ù–û–ô –°–¢–ò–õ–¨ */
        body { margin: 0; background: #111; overflow: hidden; font-family: 'Roboto', sans-serif; color: #e0c097; }
        #container { position: relative; width: 100vw; height: 100vh; }
        
        /* –í–ò–î–ï–û –ò –•–û–õ–°–¢ */
        video#input-video { width: 100%; height: 100%; object-fit: cover; display: none; }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }

        /* –ò–ù–¢–ï–†–§–ï–ô–° */
        .ui-layer { position: absolute; top:0; left:0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; z-index: 20; }
        
        /* –í–ï–†–•–ù–Ø–Ø –ü–ê–ù–ï–õ–¨ */
        .top-panel { 
            background: rgba(0,0,0,0.7); padding: 15px; pointer-events: auto; text-align: center; 
            border-bottom: 2px solid #c5a059; backdrop-filter: blur(5px);
        }
        .app-title { font-family: 'Cinzel', serif; font-size: 22px; color: #c5a059; letter-spacing: 2px; }
        
        /* –ù–ò–ñ–ù–Ø–Ø –ü–ê–ù–ï–õ–¨ */
        .bottom-panel { 
            padding: 40px; pointer-events: auto; text-align: center; 
            background: linear-gradient(to top, rgba(0,0,0,0.95), transparent); 
            display: flex; justify-content: center; gap: 20px; 
        }
        
        /* –ö–ù–û–ü–ö–ê –ó–ê–¢–í–û–†–ê (–°–î–ï–õ–ê–¢–¨ –§–û–¢–û) */
        .shutter-btn { 
            background: rgba(197, 160, 89, 0.2); 
            border: 4px solid #c5a059; width: 80px; height: 80px; border-radius: 50%; 
            position: relative; cursor: pointer; transition: transform 0.1s;
        }
        .shutter-btn::after {
            content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 60px; height: 60px; background: #c5a059; border-radius: 50%;
            box-shadow: 0 0 20px rgba(197, 160, 89, 0.5);
        }
        .shutter-btn:active { transform: scale(0.9); }

        /* –ö–ù–û–ü–ö–ê –ü–ï–†–ï–°–ù–Ø–¢–¨ */
        .retry-btn {
            display: none; padding: 15px 30px; border: 2px solid #c5a059; background: #000; color: #c5a059;
            font-family: 'Cinzel'; font-weight: bold; border-radius: 30px; cursor: pointer; text-transform: uppercase;
        }

        /* –ü–†–ò–¶–ï–õ */
        .hud-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; opacity: 0.8; }
        .scan-frame { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            width: 85%; height: 65%; border: 1px solid rgba(255,255,255,0.4); border-radius: 15px; 
        }

        /* –û–ö–ù–û –†–ï–ó–£–õ–¨–¢–ê–¢–ê */
        #result-popup { 
            position: absolute; bottom: 0; left: 0; width: 100%; max-height: 55%; 
            background: #111; border-top: 3px solid #c5a059; 
            z-index: 100; display: none; flex-direction: column; 
            border-radius: 20px 20px 0 0; box-shadow: 0 -10px 50px rgba(0,0,0,1);
        }
        .res-header { padding: 15px; text-align: center; font-family: 'Cinzel'; color: #c5a059; font-size: 18px; border-bottom: 1px solid #333; }
        .res-body { padding: 20px; overflow-y: auto; color: #ddd; }
        
        /* –°–ü–ò–°–û–ö –ö–ê–†–¢ */
        .card-row { 
            display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #222; 
        }
        .card-num { 
            width: 25px; height: 25px; background: #c5a059; color: #000; border-radius: 50%; 
            display: flex; justify-content: center; align-items: center; font-weight: bold; margin-right: 15px; 
        }
        .card-name { font-size: 16px; color: #fff; }

        /* –≠–ö–†–ê–ù –ó–ê–ì–†–£–ó–ö–ò */
        #start-screen { 
            position: absolute; top:0; left:0; width:100%; height:100%; background:#0b0b0b; z-index:999; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; 
        }
        .loader { 
            width: 40px; height: 40px; border: 4px solid #333; border-top: 4px solid #c5a059; 
            border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #error-log { color: #ff5555; margin-top: 20px; font-size: 12px; max-width: 90%; text-align: center; }
        
        /* –ö–Ω–æ–ø–∫–∞ —Å—Ç–∞—Ä—Ç (–µ—Å–ª–∏ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª) */
        #start-btn {
            margin-top: 20px; padding: 10px 20px; display: none; background: transparent; 
            border: 1px solid #c5a059; color: #c5a059; cursor: pointer; font-family: 'Cinzel';
        }
    </style>
</head>
<body>

    <div id="container">
        <div id="start-screen">
            <h1 style="font-family: 'Cinzel'; color: #c5a059; margin-bottom: 10px;">RIDER PRO</h1>
            <div class="loader"></div>
            <div id="loading-msg" style="color: #666;">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã...</div>
            <div id="error-log"></div>
            <button id="start-btn" onclick="initSystem()">–ó–ê–ü–£–°–¢–ò–¢–¨</button>
        </div>

        <video id="input-video" playsinline muted autoplay></video>
        <canvas id="canvas"></canvas>
        
        <div class="hud-layer" id="hud">
            <div class="scan-frame"></div>
        </div>
        
        <div class="ui-layer">
            <div class="top-panel"><div class="app-title">RIDER WAITE</div></div>
            
            <div class="bottom-panel">
                <div id="shutter" class="shutter-btn" onclick="takePhoto()"></div>
                <button id="retry" class="retry-btn" onclick="resetScanner()">‚Ü∫ –ù–û–í–´–ô –°–ö–ê–ù</button>
            </div>
        </div>

        <div id="result-popup">
            <div class="res-header">–†–ê–°–ö–õ–ê–î –û–ü–†–ï–î–ï–õ–ï–ù</div>
            <div class="res-body">
                <div id="cards-list"></div>
                <p style="color: #666; font-size: 12px; text-align: center; margin-top: 20px;">
                    –ì–µ–æ–º–µ—Ç—Ä–∏—è —Ä–∞—Å–∫–ª–∞–¥–∞ —É—á—Ç–µ–Ω–∞ (2D)
                </p>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // 1. –ë–ê–ó–ê –î–ê–ù–ù–´–• (78 –ö–ê–†–¢ RIDER WAITE)
        // ==========================================
        const MAJORS = [
            "Fool", "Magician", "High Priestess", "Empress", "Emperor", 
            "Hierophant", "Lovers", "Chariot", "Strength", "Hermit", 
            "Wheel of Fortune", "Justice", "Hanged Man", "Death", "Temperance", 
            "Devil", "Tower", "Star", "Moon", "Sun", "Judgement", "World"
        ];
        const SUITS = ["Wands", "Cups", "Swords", "Pentacles"];
        const RANKS = ["Ace", "Two", "Three", "Four", "Five", "Six", "Seven", "Eight", "Nine", "Ten", "Page", "Knight", "Queen", "King"];
        
        const TAROT_DATA = [...MAJORS];
        SUITS.forEach(s => RANKS.forEach(r => TAROT_DATA.push(`${r} of ${s}`)));

        // ==========================================
        // 2. –ù–ê–°–¢–†–û–ô–ö–ò –°–ò–°–¢–ï–ú–´
        // ==========================================
        const MODEL_PATH = './rider_5k_640.onnx'; // –ò–º—è —Ñ–∞–π–ª–∞ –º–æ–¥–µ–ª–∏
        const MODEL_SIZE = 640; 
        const CONFIDENCE = 0.40; 
        const NMS_THRESHOLD = 0.45;

        let session;
        const video = document.getElementById('input-video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        // –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
        ort.env.wasm.numThreads = 1; 
        ort.env.wasm.simd = false;

        // ==========================================
        // 3. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
        // ==========================================
        async function initSystem() {
            document.getElementById('start-btn').style.display = 'none';
            const log = document.getElementById('loading-msg');
            
            try {
                log.innerText = "–î–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ...";
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment', width: {ideal: 1920}, height: {ideal: 1080} },
                    audio: false 
                });
                video.srcObject = stream;
                video.style.display = 'block'; 
                await new Promise(r => video.onloadedmetadata = r);

                log.innerText = "–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–µ–π—Ä–æ—Å–µ—Ç–∏ (640px)...";
                session = await ort.InferenceSession.create(MODEL_PATH, { executionProviders: ['wasm'] });

                document.getElementById('start-screen').style.opacity = '0';
                setTimeout(() => { document.getElementById('start-screen').style.display = 'none'; }, 500);
                
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;

            } catch (e) {
                console.error(e);
                document.getElementById('error-log').innerText = "–û–®–ò–ë–ö–ê: " + e.message + "\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–∞–π–ª rider_5k_640.onnx";
                document.getElementById('start-btn').style.display = 'inline-block';
                document.getElementById('start-btn').innerText = "–ü–û–í–¢–û–†–ò–¢–¨";
            }
        }
        
        window.onload = () => document.getElementById('start-btn').style.display = 'inline-block';

        // ==========================================
        // 4. –§–û–¢–û-–°–™–ï–ú–ö–ê
        // ==========================================
        async function takePhoto() {
            if (!session) return;
            
            // –ó–∞–º–æ—Ä–∞–∂–∏–≤–∞–µ–º –≤–∏–¥–µ–æ
            video.pause();
            
            // –ü—Ä—è—á–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å—ä–µ–º–∫–∏
            document.getElementById('shutter').style.display = 'none';
            document.getElementById('hud').style.display = 'none';
            
            // –†–∏—Å—É–µ–º –∫–∞–¥—Ä
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);

            // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∞–ª–∏–∑
            await runInference();

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –≤–æ–∑–≤—Ä–∞—Ç–∞
            document.getElementById('retry').style.display = 'inline-block';
        }

        // ==========================================
        // 5. –†–ê–°–ü–û–ó–ù–ê–í–ê–ù–ò–ï (YOLO)
        // ==========================================
        async function runInference() {
            // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ 640x640
            const mat = document.createElement('canvas');
            mat.width = MODEL_SIZE; mat.height = MODEL_SIZE;
            mat.getContext('2d').drawImage(video, 0, 0, MODEL_SIZE, MODEL_SIZE);
            const data = mat.getContext('2d').getImageData(0,0,MODEL_SIZE,MODEL_SIZE).data;
            
            const input = new Float32Array(3 * MODEL_SIZE * MODEL_SIZE);
            for (let i=0; i<MODEL_SIZE*MODEL_SIZE; i++) {
                input[i] = data[i*4]/255.0;
                input[MODEL_SIZE*MODEL_SIZE+i] = data[i*4+1]/255.0;
                input[2*MODEL_SIZE*MODEL_SIZE+i] = data[i*4+2]/255.0;
            }
            const tensor = new ort.Tensor('float32', input, [1, 3, MODEL_SIZE, MODEL_SIZE]);

            const results = await session.run({ [session.inputNames[0]]: tensor });
            processResults(results[session.outputNames[0]].data);
        }

        // ==========================================
        // 6. –û–ë–†–ê–ë–û–¢–ö–ê, –°–û–†–¢–ò–†–û–í–ö–ê –ò –û–¢–†–ò–°–û–í–ö–ê
        // ==========================================
        function processResults(data) {
            const numClasses = 78; 
            const channels = numClasses + 4; 
            const dynamicAnchors = data.length / channels;
            
            let boxes = [];
            for (let i=0; i<dynamicAnchors; i++) {
                let maxConf = 0; let classIdx = 0;
                for(let c=4; c<channels; c++) {
                    const val = data[c*dynamicAnchors+i];
                    if(val > maxConf) { maxConf = val; classIdx = c-4; }
                }
                if (maxConf > CONFIDENCE) { 
                    const x = data[0*dynamicAnchors+i]; const y = data[1*dynamicAnchors+i];
                    const w = data[2*dynamicAnchors+i]; const h = data[3*dynamicAnchors+i];
                    boxes.push({ x: x, y: y, w: w, h: h, score: maxConf, classId: classIdx });
                }
            }

            // NMS
            boxes.sort((a,b) => b.score - a.score);
            const cleanBoxes = [];
            while(boxes.length > 0) {
                const best = boxes.shift(); cleanBoxes.push(best);
                boxes = boxes.filter(b => {
                    const x1 = Math.max(best.x - best.w/2, b.x - b.w/2); const y1 = Math.max(best.y - best.h/2, b.y - b.h/2);
                    const x2 = Math.min(best.x + best.w/2, b.x + b.w/2); const y2 = Math.min(best.y + best.h/2, b.y + b.h/2);
                    if (x2 < x1 || y2 < y1) return true;
                    return ((x2-x1)*(y2-y1)) / (best.w*best.h + b.w*b.h - (x2-x1)*(y2-y1)) < NMS_THRESHOLD;
                });
            }

            // üî• –£–ú–ù–ê–Ø –°–û–†–¢–ò–†–û–í–ö–ê 2D (–ö—Ä–µ—Å—Ç, –†—è–¥—ã)
            const sortedBoxes = smartSort2D(cleanBoxes);

            // –û–¢–†–ò–°–û–í–ö–ê
            const sx = canvas.width / MODEL_SIZE;
            const sy = canvas.height / MODEL_SIZE;
            const foundNames = [];

            ctx.lineWidth = 3;
            ctx.font = "bold 16px Roboto";

            sortedBoxes.forEach((box, index) => {
                const x = (box.x - box.w/2) * sx;
                const y = (box.y - box.h/2) * sy;
                const w = box.w * sx;
                const h = box.h * sy;

                // –†–∞–º–∫–∞
                ctx.strokeStyle = "#c5a059";
                ctx.strokeRect(x, y, w, h);
                
                // –ò–º—è
                let label = TAROT_DATA[box.classId] || `Card ${box.classId}`;
                
                // –†–∏—Å—É–µ–º –∫—Ä—É–∂–æ–∫ —Å –Ω–æ–º–µ—Ä–æ–º
                ctx.fillStyle = "#c5a059";
                ctx.beginPath(); ctx.arc(x, y, 14, 0, 2*Math.PI); ctx.fill();
                
                ctx.fillStyle = "#000";
                ctx.fillText(index + 1, x - 5, y + 5);

                // –ü–æ–¥–ø–∏—Å—å
                ctx.fillStyle = "#c5a059";
                ctx.fillText(label, x + 20, y - 5);
                
                foundNames.push(label);
            });

            if (foundNames.length > 0) {
                showResults(foundNames);
            } else {
                alert("–ö–∞—Ä—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.");
                resetScanner();
            }
        }

        // ==========================================
        // 7. –ê–õ–ì–û–†–ò–¢–ú –£–ú–ù–û–ô –°–û–†–¢–ò–†–û–í–ö–ò (GEOMETRY)
        // ==========================================
        function smartSort2D(cards) {
            if (cards.length === 0) return [];
            // 1. –ì—Ä—É–±–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ Y
            cards.sort((a, b) => a.y - b.y);

            const rows = [];
            let currentRow = [cards[0]];
            // –ü–æ—Ä–æ–≥ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è –≤ —Å—Ç—Ä–æ–∫—É: 50% –≤—ã—Å–æ—Ç—ã —Å–∞–º–æ–π –∫–∞—Ä—Ç—ã (–ø—Ä–∏–º–µ—Ä–Ω–æ)
            const Y_THRESHOLD = cards[0].h * 0.5; 

            for (let i = 1; i < cards.length; i++) {
                const card = cards[i];
                const prevCard = currentRow[0];
                
                if (Math.abs(card.y - prevCard.y) < Y_THRESHOLD) {
                    currentRow.push(card);
                } else {
                    rows.push(currentRow);
                    currentRow = [card];
                }
            }
            rows.push(currentRow);

            // 2. –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –≤–Ω—É—Ç—Ä–∏ —Å—Ç—Ä–æ–∫ –ø–æ X
            let finalOrder = [];
            rows.forEach(row => {
                row.sort((a, b) => a.x - b.x);
                finalOrder = finalOrder.concat(row);
            });
            return finalOrder;
        }

        // ==========================================
        // 8. –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –°–ü–ò–°–ö–ê
        // ==========================================
        function showResults(names) {
            const list = document.getElementById('cards-list');
            list.innerHTML = "";
            names.forEach((name, i) => {
                list.innerHTML += `
                    <div class="card-row">
                        <div class="card-num">${i + 1}</div>
                        <div class="card-name">${name}</div>
                    </div>
                `;
            });
            document.getElementById('result-popup').style.display = 'flex';
        }

        function resetScanner() {
            video.play();
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            document.getElementById('shutter').style.display = 'block';
            document.getElementById('retry').style.display = 'none';
            document.getElementById('result-popup').style.display = 'none';
            document.getElementById('hud').style.display = 'block';
        }
    </script>
</body>
</html>
