<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RIDER WAITE: ФОТО СКАНЕР</title>
    
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.14.0/dist/ort.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* === 1. ОСНОВА === */
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Roboto', sans-serif; }
        #app { position: relative; width: 100vw; height: 100vh; }
        
        /* Видео (камера) */
        video { width: 100%; height: 100%; object-fit: cover; }
        
        /* Холст для рамок (рисуем поверх видео) */
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }

        /* === 2. ИНТЕРФЕЙС СКАНИРОВАНИЯ === */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 20; display: flex; flex-direction: column; justify-content: space-between; pointer-events: none; }
        
        .header { 
            background: rgba(0,0,0,0.6); padding: 15px; text-align: center; color: #ffd700; 
            font-size: 18px; font-weight: bold; letter-spacing: 1px; pointer-events: auto;
        }
        
        .footer { 
            padding: 30px; display: flex; justify-content: center; align-items: center; 
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); pointer-events: auto;
        }
        
        /* КНОПКА СЪЕМКИ */
        #shutter-btn {
            width: 80px; height: 80px; border-radius: 50%; border: 4px solid #ffd700;
            background: rgba(255, 215, 0, 0.3); cursor: pointer; position: relative;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.4); transition: transform 0.1s;
        }
        #shutter-btn:active { transform: scale(0.9); background: #ffd700; }

        /* СТАТУС (сколько карт видит) */
        #status-pill {
            position: absolute; top: 70px; left: 50%; transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7); border: 1px solid #ffd700; color: #fff;
            padding: 8px 16px; border-radius: 20px; font-size: 14px;
        }

        /* === 3. ЭКРАН РЕЗУЛЬТАТА (НА ВЕСЬ ЭКРАН) === */
        #result-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #111; z-index: 50; display: none; flex-direction: column;
        }
        
        /* Верхняя часть: ВИЗУАЛЬНЫЙ РАСКЛАД (70% экрана) */
        #visual-layout {
            flex: 2; /* Занимает больше места */
            background: #0e0e0e; 
            position: relative; 
            margin: 10px; border: 1px dashed #444; border-radius: 10px;
            overflow: hidden;
        }
        
        /* Карточка в раскладе */
        .layout-card {
            position: absolute; border: 2px solid #ffd700; border-radius: 5px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.8); transition: all 0.3s;
        }
        .layout-card img { width: 100%; height: 100%; object-fit: cover; border-radius: 3px; }
        .layout-card-label {
            position: absolute; bottom: -25px; left: 50%; transform: translateX(-50%);
            color: #fff; font-size: 10px; white-space: nowrap; text-shadow: 0 1px 3px #000;
            background: rgba(0,0,0,0.7); padding: 2px 5px; border-radius: 4px;
        }

        /* Нижняя часть: ИНФО И КНОПКИ (30% экрана) */
        #result-controls {
            flex: 1; border-top: 2px solid #ffd700; background: #1a1a1a;
            padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: space-around;
        }
        
        .result-title { color: #ffd700; font-size: 18px; margin-bottom: 5px; }
        .result-subtitle { color: #888; font-size: 12px; margin-bottom: 15px; }

        /* КНОПКА ПОВТОРА */
        #retry-btn {
            width: 100%; max-width: 300px; padding: 15px; 
            background: #ffd700; color: #000; font-weight: bold; font-size: 16px;
            border: none; border-radius: 10px; cursor: pointer; text-transform: uppercase;
        }

        /* === 4. ЗАГРУЗЧИК === */
        #loader {
            position: absolute; top:0; left:0; width:100%; height:100%; background:#000; z-index:100;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .spinner { width:40px; height:40px; border:4px solid #333; border-top:4px solid #ffd700; border-radius:50%; animation: spin 1s infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        #start-btn { display:none; margin-top:20px; padding:10px 30px; background:transparent; border:1px solid #ffd700; color:#ffd700; }
    </style>
</head>
<body>

<div id="app">
    <div id="loader">
        <h1 style="color: #ffd700; font-weight: normal;">RIDER 5K</h1>
        <div class="spinner"></div>
        <p id="load-text" style="color: #666; font-size: 12px; margin-top: 15px;">Загрузка нейросети...</p>
        <button id="start-btn" onclick="init()">ЗАПУСТИТЬ КАМЕРУ</button>
        <p id="err-log" style="color: red; font-size: 10px; max-width:80%; text-align:center;"></p>
    </div>

    <video id="video" playsinline muted autoplay></video>
    <canvas id="canvas"></canvas>

    <div id="ui-layer">
        <div class="header">СКАНЕР ТАРО</div>
        <div id="status-pill">Наведите на карты</div>
        <div class="footer">
            <div id="shutter-btn" onclick="capture()"></div>
        </div>
    </div>

    <div id="result-screen">
        <div id="visual-layout">
            <div style="position: absolute; top:50%; left:50%; transform:translate(-50%,-50%); color:#555;">Нет карт</div>
        </div>

        <div id="result-controls">
            <div>
                <div class="result-title">РАСКЛАД ЗАФИКСИРОВАН</div>
                <div class="result-subtitle">Геометрия сохранена. Картинки загружены.</div>
            </div>
            <button id="retry-btn" onclick="retry()">↺ СКАНИРОВАТЬ ЕЩЕ РАЗ</button>
        </div>
    </div>
</div>

<script>
    // === ДАННЫЕ: ИМЕНА И ССЫЛКИ НА КАРТИНКИ (GITHUB) ===
    const BASE_URL = "https://raw.githubusercontent.com/marataitester-blip/rider-tarot-card/main/Cards-jpg/Cards-jpg/";
    const CARDS_DB = [];

    // Старшие Арканы (Имена файлов должны совпадать с GitHub!)
    const MAJORS = [
        {f: "00-TheFool.jpg", ru: "Шут"}, {f: "01-TheMagician.jpg", ru: "Маг"}, {f: "02-TheHighPriestess.jpg", ru: "Жрица"},
        {f: "03-TheEmpress.jpg", ru: "Императрица"}, {f: "04-TheEmperor.jpg", ru: "Император"}, {f: "05-TheHierophant.jpg", ru: "Жрец"},
        {f: "06-TheLovers.jpg", ru: "Влюбленные"}, {f: "07-TheChariot.jpg", ru: "Колесница"}, {f: "08-Strength.jpg", ru: "Сила"},
        {f: "09-TheHermit.jpg", ru: "Отшельник"}, {f: "10-WheelOfFortune.jpg", ru: "Колесо Фортуны"}, {f: "11-Justice.jpg", ru: "Справедливость"},
        {f: "12-TheHangedMan.jpg", ru: "Повешенный"}, {f: "13-Death.jpg", ru: "Смерть"}, {f: "14-Temperance.jpg", ru: "Умеренность"},
        {f: "15-TheDevil.jpg", ru: "Дьявол"}, {f: "16-TheTower.jpg", ru: "Башня"}, {f: "17-TheStar.jpg", ru: "Звезда"},
        {f: "18-TheMoon.jpg", ru: "Луна"}, {f: "19-TheSun.jpg", ru: "Солнце"}, {f: "20-Judgement.jpg", ru: "Суд"},
        {f: "21-TheWorld.jpg", ru: "Мир"}
    ];
    MAJORS.forEach(c => CARDS_DB.push({ name: c.ru, img: BASE_URL + c.f }));

    // Младшие Арканы
    const SUITS = [
        {id: "Wands", ru: "Жезлов"}, {id: "Cups", ru: "Кубков"},
        {id: "Swords", ru: "Мечей"}, {id: "Pentacles", ru: "Пентаклей"}
    ];
    const RANKS_RU = ["Туз", "2", "3", "4", "5", "6", "7", "8", "9", "10", "Паж", "Рыцарь", "Королева", "Король"];
    
    SUITS.forEach(suit => {
        RANKS_RU.forEach((rank, i) => {
            // Формируем имя файла как на GitHub: Wands01.jpg, Wands10.jpg...
            let num = (i + 1).toString().padStart(2, '0');
            let filename = `${suit.id}${num}.jpg`;
            CARDS_DB.push({ name: `${rank} ${suit.ru}`, img: BASE_URL + filename });
        });
    });

    // === НАСТРОЙКИ ===
    const CONFIG = {
        modelPath: './rider_5k_640.onnx',
        modelSize: 640,
        conf: 0.40,
        nms: 0.50
    };

    let session = null;
    let isPaused = false;
    let lastBoxes = []; // Тут храним последние найденные карты

    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const statusPill = document.getElementById('status-pill');

    // === 1. ЗАПУСК ===
    async function init() {
        document.getElementById('start-btn').style.display = 'none';
        const loadTxt = document.getElementById('load-text');
        
        try {
            // Камера
            loadTxt.innerText = "Доступ к камере...";
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: 'environment', width: { ideal: 1280 } },
                audio: false
            });
            video.srcObject = stream;
            video.play();
            await new Promise(r => video.onloadedmetadata = r);

            // Модель
            loadTxt.innerText = "Загрузка нейросети...";
            session = await ort.InferenceSession.create(CONFIG.modelPath, { executionProviders: ['wasm'] });

            // Старт
            document.getElementById('loader').style.display = 'none';
            resizeCanvas();
            loop(); // Запуск цикла распознавания

        } catch (e) {
            console.error(e);
            document.getElementById('err-log').innerText = e.message;
            document.getElementById('start-btn').style.display = 'block';
        }
    }
    
    // Показать кнопку, если автозапуск блокирован
    window.onload = () => document.getElementById('start-btn').style.display = 'inline-block';

    function resizeCanvas() {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
    }

    // === 2. ЦИКЛ РАСПОЗНАВАНИЯ (LIVE) ===
    async function loop() {
        if (isPaused) return;

        // Подготовка картинки
        const mat = document.createElement('canvas');
        mat.width = CONFIG.modelSize; mat.height = CONFIG.modelSize;
        mat.getContext('2d').drawImage(video, 0, 0, CONFIG.modelSize, CONFIG.modelSize);
        const data = mat.getContext('2d').getImageData(0,0,CONFIG.modelSize,CONFIG.modelSize).data;
        
        const input = new Float32Array(3 * CONFIG.modelSize * CONFIG.modelSize);
        for (let i=0; i<CONFIG.modelSize*CONFIG.modelSize; i++) {
            input[i] = data[i*4]/255.0;
            input[CONFIG.modelSize*CONFIG.modelSize+i] = data[i*4+1]/255.0;
            input[2*CONFIG.modelSize*CONFIG.modelSize+i] = data[i*4+2]/255.0;
        }
        
        const tensor = new ort.Tensor('float32', input, [1, 3, CONFIG.modelSize, CONFIG.modelSize]);
        
        try {
            const res = await session.run({ [session.inputNames[0]]: tensor });
            const output = res[session.outputNames[0]].data;
            drawBoxes(output);
        } catch(e) { console.error(e); }

        requestAnimationFrame(loop);
    }

    // === 3. ОТРИСОВКА РАМОК ===
    function drawBoxes(data) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Парсинг YOLO
        const numClasses = 78;
        const channels = numClasses + 4;
        const anchors = data.length / channels;
        let boxes = [];

        for(let i=0; i<anchors; i++) {
            let max = 0, cls = 0;
            for(let c=4; c<channels; c++) {
                let val = data[c*anchors+i];
                if(val > max) { max = val; cls = c-4; }
            }
            if(max > CONFIG.conf) {
                const x = data[0*anchors+i]; const y = data[1*anchors+i];
                const w = data[2*anchors+i]; const h = data[3*anchors+i];
                boxes.push({x, y, w, h, score: max, cls});
            }
        }

        // NMS (Фильтр)
        boxes.sort((a,b) => b.score - a.score);
        let active = [];
        while(boxes.length) {
            let best = boxes.shift(); active.push(best);
            boxes = boxes.filter(b => {
                let x1 = Math.max(best.x-best.w/2, b.x-b.w/2), y1 = Math.max(best.y-best.h/2, b.y-b.h/2);
                let x2 = Math.min(best.x+best.w/2, b.x+b.w/2), y2 = Math.min(best.y+best.h/2, b.y+b.h/2);
                if(x2<x1 || y2<y1) return true;
                let inter = (x2-x1)*(y2-y1);
                let union = (best.w*best.h) + (b.w*b.h) - inter;
                return (inter/union) < CONFIG.nms;
            });
        }

        lastBoxes = active;
        statusPill.innerText = `Вижу карт: ${active.length}`;

        // Рисуем на экране
        const sx = canvas.width / CONFIG.modelSize;
        const sy = canvas.height / CONFIG.modelSize;
        
        ctx.lineWidth = 4;
        ctx.strokeStyle = "#00ff00"; // ЯРКО-ЗЕЛЕНЫЙ
        
        active.forEach(b => {
            ctx.strokeRect((b.x - b.w/2)*sx, (b.y - b.h/2)*sy, b.w*sx, b.h*sy);
        });
    }

    // === 4. СНИМОК И ГЕНЕРАЦИЯ РЕЗУЛЬТАТА ===
    function capture() {
        if(lastBoxes.length === 0) { alert("Не вижу карт!"); return; }
        
        isPaused = true; // Стоп нейросеть
        video.pause();   // Стоп видео

        // Скрываем UI сканера
        document.getElementById('ui-layer').style.display = 'none';
        
        // Показываем экран результата
        const resScreen = document.getElementById('result-screen');
        resScreen.style.display = 'flex';

        renderVisual(lastBoxes);
    }

    function renderVisual(boxes) {
        const container = document.getElementById('visual-layout');
        container.innerHTML = "";

        // Находим границы расклада
        let minX=Infinity, maxX=-Infinity, minY=Infinity, maxY=-Infinity;
        boxes.forEach(b => {
            minX = Math.min(minX, b.x); maxX = Math.max(maxX, b.x);
            minY = Math.min(minY, b.y); maxY = Math.max(maxY, b.y);
        });
        
        // Добавляем отступы
        let W = (maxX - minX) * 1.5; if(W===0) W=100;
        let H = (maxY - minY) * 1.5; if(H===0) H=100;
        let cX = (minX + maxX) / 2;
        let cY = (minY + maxY) / 2;

        boxes.forEach(b => {
            let card = CARDS_DB[b.cls];
            if(!card) return;

            let el = document.createElement('div');
            el.className = 'layout-card';
            
            // Расчет позиции в %
            let left = 50 + ((b.x - cX) / W) * 80;
            let top = 50 + ((b.y - cY) / H) * 80;
            let width = (b.w / W) * 70; // Масштаб карты
            
            el.style.left = left + "%";
            el.style.top = top + "%";
            el.style.width = width + "%";
            // Пропорция карты 1:1.7
            el.style.height = (width * 1.7) + "%"; 
            el.style.transform = "translate(-50%, -50%)";

            el.innerHTML = `
                <img src="${card.img}">
                <div class="layout-card-label">${card.name}</div>
            `;
            container.appendChild(el);
        });
    }

    // === 5. ПОВТОР ===
    function retry() {
        isPaused = false;
        video.play();
        document.getElementById('result-screen').style.display = 'none';
        document.getElementById('ui-layer').style.display = 'flex';
        loop();
    }

</script>
</body>
</html>
