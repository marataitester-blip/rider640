<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RIDER PRO 5K</title>
    
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web@1.14.0/dist/ort.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Roboto:wght@300;400&display=swap" rel="stylesheet">
    
    <style>
        body { margin: 0; background: #0b0b0b; overflow: hidden; font-family: 'Roboto', sans-serif; color: #e0c097; }
        #container { position: relative; width: 100vw; height: 100vh; }
        
        /* Видео скрыто, показываем только при прицеливании */
        video#input-video { width: 100%; height: 100%; object-fit: cover; display: none; }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }

        /* ИНТЕРФЕЙС */
        .ui-layer { position: absolute; top:0; left:0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; z-index: 20; }
        
        .top-panel { background: rgba(0,0,0,0.6); padding: 15px; pointer-events: auto; text-align: center; backdrop-filter: blur(5px); }
        .app-title { font-family: 'Cinzel', serif; font-size: 24px; color: #e0c097; letter-spacing: 2px; text-shadow: 0 2px 5px rgba(0,0,0,0.8); }
        
        .bottom-panel { padding: 40px; pointer-events: auto; text-align: center; background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); display: flex; justify-content: center; gap: 20px; }
        
        /* КНОПКА СЪЕМКИ */
        .shutter-btn { 
            background: rgba(224, 192, 151, 0.2); 
            border: 4px solid #e0c097; width: 80px; height: 80px; border-radius: 50%; 
            position: relative; cursor: pointer; transition: 0.2s;
        }
        .shutter-btn::after {
            content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 60px; height: 60px; background: #e0c097; border-radius: 50%;
            box-shadow: 0 0 20px rgba(224, 192, 151, 0.5);
        }
        .shutter-btn:active { transform: scale(0.9); }
        .shutter-btn:active::after { background: #fff; }

        /* Кнопка "Переснять" */
        .retry-btn {
            display: none; padding: 15px 30px; border: 2px solid #e0c097; background: #222; color: #e0c097;
            font-family: 'Cinzel'; font-weight: bold; border-radius: 30px; cursor: pointer;
        }

        /* ПРИЦЕЛ */
        .hud-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; opacity: 0.8; }
        .scan-frame { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 85%; height: 65%; border: 1px solid rgba(255,255,255,0.3); border-radius: 20px; }
        .corner { position: absolute; width: 20px; height: 20px; border-color: #e0c097; border-style: solid; border-width: 0; }
        .tl { top: -1px; left: -1px; border-top-width: 3px; border-left-width: 3px; border-radius: 10px 0 0 0; }
        .tr { top: -1px; right: -1px; border-top-width: 3px; border-right-width: 3px; border-radius: 0 10px 0 0; }
        .bl { bottom: -1px; left: -1px; border-bottom-width: 3px; border-left-width: 3px; border-radius: 0 0 0 10px; }
        .br { bottom: -1px; right: -1px; border-bottom-width: 3px; border-right-width: 3px; border-radius: 0 0 10px 0; }

        /* РЕЗУЛЬТАТ */
        #result-popup { 
            position: absolute; bottom: 0; left: 0; width: 100%; max-height: 60%; 
            background: #111; border-top: 2px solid #e0c097; 
            z-index: 100; display: none; flex-direction: column; 
            border-radius: 20px 20px 0 0; box-shadow: 0 -10px 50px rgba(0,0,0,0.8);
        }
        .res-header { padding: 15px; text-align: center; font-family: 'Cinzel'; color: #fff; font-size: 18px; border-bottom: 1px solid #333; }
        .res-body { padding: 20px; overflow-y: auto; text-align: center; color: #ddd; }
        .card-list { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-bottom: 15px; }
        .card-tag { padding: 5px 10px; background: #333; border: 1px solid #555; border-radius: 5px; font-size: 12px; }

        /* ЭКРАН ЗАГРУЗКИ */
        #start-screen { position: absolute; top:0; left:0; width:100%; height:100%; background:#0b0b0b; z-index:999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
        .loader { width: 40px; height: 40px; border: 4px solid #333; border-top: 4px solid #e0c097; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #error-log { color: red; margin-top: 20px; font-size: 12px; max-width: 80%; text-align: center; }
    </style>
</head>
<body>

    <div id="container">
        <div id="start-screen">
            <div class="loader"></div>
            <div style="color: #888; font-family: 'Cinzel';">INITIALIZING RIDER...</div>
            <div id="error-log"></div>
            <button id="start-btn" onclick="initSystem()" style="margin-top: 20px; padding: 10px 30px; display: none; border: 1px solid #e0c097; background: transparent; color: #e0c097;">START CAMERA</button>
        </div>

        <video id="input-video" playsinline muted autoplay></video>
        <canvas id="canvas"></canvas>
        
        <div class="hud-layer" id="hud">
            <div class="scan-frame">
                <div class="corner tl"></div><div class="corner tr"></div>
                <div class="corner bl"></div><div class="corner br"></div>
            </div>
        </div>
        
        <div class="ui-layer">
            <div class="top-panel"><div class="app-title">RIDER WAITE</div></div>
            <div class="bottom-panel">
                <div id="shutter" class="shutter-btn" onclick="takePhoto()"></div>
                <button id="retry" class="retry-btn" onclick="resetScanner()">↺ SCAN AGAIN</button>
            </div>
        </div>

        <div id="result-popup">
            <div class="res-header">DETECTED CARDS</div>
            <div class="res-body">
                <div id="cards-list" class="card-list"></div>
                <div id="ai-text" style="font-size: 14px; line-height: 1.5; color: #888;">(AI Interpretation would go here...)</div>
            </div>
        </div>
    </div>

    <script>
        // === 1. БАЗА КАРТ (ПОЛНАЯ) ===
        const MAJORS = [
            "The Fool", "The Magician", "The High Priestess", "The Empress", "The Emperor", 
            "The Hierophant", "The Lovers", "The Chariot", "Strength", "The Hermit", 
            "Wheel of Fortune", "Justice", "The Hanged Man", "Death", "Temperance", 
            "The Devil", "The Tower", "The Star", "The Moon", "The Sun", "Judgement", "The World"
        ];
        const SUITS = ["Wands", "Cups", "Swords", "Pentacles"];
        const RANKS = ["Ace", "Two", "Three", "Four", "Five", "Six", "Seven", "Eight", "Nine", "Ten", "Page", "Knight", "Queen", "King"];
        
        const TAROT_DATA = [...MAJORS];
        SUITS.forEach(s => RANKS.forEach(r => TAROT_DATA.push(`${r} of ${s}`)));

        // === 2. НАСТРОЙКИ ===
        const MODEL_PATH = './rider_5k_640.onnx'; // Имя файла в корне
        const MODEL_SIZE = 640; 
        const CONFIDENCE = 0.45; 
        const NMS_THRESHOLD = 0.45;

        let session;
        const video = document.getElementById('input-video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        // Оптимизация для Vercel/Mobile
        ort.env.wasm.numThreads = 1; 
        ort.env.wasm.simd = false; 

        async function initSystem() {
            document.getElementById('start-btn').style.display = 'none';
            const errLog = document.getElementById('error-log');
            
            try {
                // Камера
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment', width: {ideal: 1280}, height: {ideal: 720} },
                    audio: false 
                });
                video.srcObject = stream;
                video.style.display = 'block'; 
                await new Promise(r => video.onloadedmetadata = r);
                
                // Модель
                try {
                    session = await ort.InferenceSession.create(MODEL_PATH, { executionProviders: ['wasm'] });
                } catch (e) {
                    throw new Error("Failed to load ONNX model. Check if 'rider_5k_640.onnx' is in the root folder.");
                }
                
                document.getElementById('start-screen').style.opacity = '0';
                setTimeout(() => { document.getElementById('start-screen').style.display = 'none'; }, 500);
                
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;

            } catch (e) {
                console.error(e);
                errLog.innerText = e.message;
                document.getElementById('start-btn').style.display = 'inline-block';
                document.getElementById('start-btn').innerText = "RETRY";
            }
        }

        // Автостарт (попытка)
        window.onload = () => document.getElementById('start-btn').style.display = 'inline-block';

        async function takePhoto() {
            if (!session) return;
            
            video.pause();
            document.getElementById('shutter').style.display = 'none';
            document.getElementById('hud').style.display = 'none';
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);

            await runInference();
            document.getElementById('retry').style.display = 'inline-block';
        }

        async function runInference() {
            const mat = document.createElement('canvas');
            mat.width = MODEL_SIZE; mat.height = MODEL_SIZE;
            mat.getContext('2d').drawImage(video, 0, 0, MODEL_SIZE, MODEL_SIZE);
            const data = mat.getContext('2d').getImageData(0,0,MODEL_SIZE,MODEL_SIZE).data;
            
            const input = new Float32Array(3 * MODEL_SIZE * MODEL_SIZE);
            for (let i=0; i<MODEL_SIZE*MODEL_SIZE; i++) {
                input[i] = data[i*4]/255.0;
                input[MODEL_SIZE*MODEL_SIZE+i] = data[i*4+1]/255.0;
                input[2*MODEL_SIZE*MODEL_SIZE+i] = data[i*4+2]/255.0;
            }
            const tensor = new ort.Tensor('float32', input, [1, 3, MODEL_SIZE, MODEL_SIZE]);

            const results = await session.run({ [session.inputNames[0]]: tensor });
            drawResults(results[session.outputNames[0]].data);
        }

        function drawResults(data) {
            const numClasses = 78; 
            const channels = numClasses + 4; 
            const dynamicAnchors = data.length / channels;
            
            let boxes = [];
            for (let i=0; i<dynamicAnchors; i++) {
                let maxConf = 0; let classIdx = 0;
                for(let c=4; c<channels; c++) {
                    const val = data[c*dynamicAnchors+i];
                    if(val > maxConf) { maxConf = val; classIdx = c-4; }
                }
                if (maxConf > CONFIDENCE) { 
                    const x = data[0*dynamicAnchors+i]; const y = data[1*dynamicAnchors+i];
                    const w = data[2*dynamicAnchors+i]; const h = data[3*dynamicAnchors+i];
                    boxes.push({ x: x, y: y, w: w, h: h, score: maxConf, classId: classIdx });
                }
            }

            boxes.sort((a,b) => b.score - a.score);
            const cleanBoxes = [];
            while(boxes.length > 0) {
                const best = boxes.shift(); cleanBoxes.push(best);
                boxes = boxes.filter(b => {
                    const x1 = Math.max(best.x - best.w/2, b.x - b.w/2); const y1 = Math.max(best.y - best.h/2, b.y - b.h/2);
                    const x2 = Math.min(best.x + best.w/2, b.x + b.w/2); const y2 = Math.min(best.y + best.h/2, b.y + b.h/2);
                    if (x2 < x1 || y2 < y1) return true;
                    return ((x2-x1)*(y2-y1)) / (best.w*best.h + b.w*b.h - (x2-x1)*(y2-y1)) < NMS_THRESHOLD;
                });
            }

            const sx = canvas.width / MODEL_SIZE;
            const sy = canvas.height / MODEL_SIZE;
            const foundNames = [];

            ctx.lineWidth = 3;
            ctx.font = "bold 20px Roboto";

            cleanBoxes.forEach(box => {
                const x = (box.x - box.w/2) * sx;
                const y = (box.y - box.h/2) * sy;
                const w = box.w * sx;
                const h = box.h * sy;

                ctx.strokeStyle = "#e0c097";
                ctx.strokeRect(x, y, w, h);
                
                let label = `ID ${box.classId}`; 
                if (TAROT_DATA[box.classId]) label = TAROT_DATA[box.classId];

                ctx.fillStyle = "#e0c097";
                ctx.fillText(label, x, y - 10);
                foundNames.push(label);
            });

            if (foundNames.length > 0) {
                document.getElementById('result-popup').style.display = 'flex';
                document.getElementById('cards-list').innerHTML = foundNames.map(n => `<div class="card-tag">${n}</div>`).join('');
                document.getElementById('ai-text').innerText = "Cards Identified. Ready for Interpretation.";
            } else {
                alert("No cards detected. Try moving closer or adding light.");
                resetScanner();
            }
        }

        function resetScanner() {
            video.play();
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            document.getElementById('shutter').style.display = 'block';
            document.getElementById('retry').style.display = 'none';
            document.getElementById('result-popup').style.display = 'none';
            document.getElementById('hud').style.display = 'block';
        }
    </script>
</body>
</html>
